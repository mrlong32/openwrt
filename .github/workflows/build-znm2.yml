name: Build ZN-M2 OpenWrt

on:
  workflow_dispatch:
    inputs:
      target:
        description: '编译目标'
        required: true
        default: 'zn-m2'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          repository: OpenWrt/OpenWrt  # 添加仓库地址
          ref: master                 # 或其他需要的分支

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev gawk flex git device-tree-compiler
          
      - name: Upload Device Tree
        uses: actions/upload-artifact@v2
        with:
          name: zn-m2.dts
          path: zn-m2.dts
        if: github.event.inputs.target == 'zn-m2'

      - name: Configure Device Tree
        run: |
          # 将设备树文件复制到正确位置
          mkdir -p targets/ipq60xx/dts/
          cp zn-m2.dts targets/ipq60xx/dts/zn-m2.dts

      - name: Update Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate .config
        run: |
          make defconfig

      - name: Compile Firmware
        run: |
          make -j$(nproc) V=s target=$target

      - name: Upload Firmware
        uses: actions/upload-artifact@v2
        with:
          name: openwrt-firmware
          path: bin/targets/*/*
