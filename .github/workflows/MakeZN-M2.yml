name: Build OpenWrt for zn-m2 (ipq60xx)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # 每周日自动构建

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-24.10
  TARGET_DEVICE: ipq60xx
  SPECIFIC_DEVICE: zn-m2
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_SCRIPT: diy.sh
  UPLOAD_ARTIFACT: true

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build zn-m2 firmware

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev \
          file wget llvm python3-pyelftools libpython3-dev aria2 jq
          sudo timedatectl set-timezone Asia/Shanghai

      - name: Clone official OpenWrt source
        run: |
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Extract ipq60xx support files from Kwrt
        run: |
          # 克隆 Kwrt 仓库获取 ipq60xx 设备支持文件
          git clone https://github.com/kiddin9/kwrt.git kwrt-tmp
          
          # 复制设备树和配置文件
          cp -rf kwrt-tmp/devices/qualcommax_ipq60xx/target/linux/qualcommax/* openwrt/target/linux/qualcommax/
          
          # 复制固件生成配置
          cp -rf kwrt-tmp/devices/qualcommax_ipq60xx/image/* openwrt/target/linux/qualcommax/image/
          
          # 复制必要补丁
          cp -rf kwrt-tmp/devices/qualcommax_ipq60xx/patches/* openwrt/target/linux/qualcommax/patches/
          
          # 复制 DIY 脚本（仅保留设备支持相关部分）
          cp kwrt-tmp/devices/qualcommax_ipq60xx/diy.sh openwrt/$DIY_SCRIPT
          chmod +x openwrt/$DIY_SCRIPT

      - name: Configure firmware
        run: |
          cd openwrt
          
          # 基础配置
          cat > $CONFIG_FILE << EOF
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_zn-m2=y
          CONFIG_DEVEL=y
          CONFIG_CCACHE=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          CONFIG_PACKAGE_firewall=y
          CONFIG_PACKAGE_opkg=y
          CONFIG_PACKAGE_wpad-basic-mbedtls=y
          EOF
          
          # 执行设备专属配置脚本
          ./$DIY_SCRIPT

      - name: Download packages
        run: |
          cd openwrt
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -delete

      - name: Compile firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Upload artifact
        if: env.UPLOAD_ARTIFACT == 'true'
        uses: actions/upload-artifact@main
        with:
          name: zn-m2-firmware
          path: openwrt/bin/targets/qualcommax/ipq60xx/
