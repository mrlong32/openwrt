name: OpenWrt Build for CSAC Router
on:
  push:
    branches: [ main ]
    paths:
      - 'target/linux/ath79/dts/csac-router.dts'
      - 'target/linux/ath79/image/Makefile'
      - '.config'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - name: 准备编译环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk         gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev         file wget curl python3 python3-pip python3-ply python3-yaml
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "Asia/Shanghai"
    - name: 配置编译选项
      run: |
        # 检查.config是否存在
if [ ! -f .config ]; then
  echo "⚠️  .config文件不存在，尝试从.sample恢复"
  if [ -f .config.csac.sample ]; then
    cp .config.csac.sample .config
    echo "✅ 从.config.csac.sample恢复.config"
  else
    echo "❌ .config和.sample文件都不存在，使用defconfig"
    make defconfig
  fi
fi
cp .config .config.backup
        make defconfig
        make download -j$(nproc)
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
    - name: 编译OpenWrt固件
      run: |
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 V=s
        echo "编译完成！"
    - name: 收集编译产物
      run: |
        mkdir -p ./artifact
        cp -f bin/targets/ath79/generic/*csac* ./artifact/
        cp -f bin/targets/ath79/generic/openwrt-ath79-generic.manifest ./artifact/
        cp -f .config ./artifact/config.buildinfo
    - name: 上传编译产物
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: ./artifact/
        retention-days: 30
    - name: 清理工作区
      if: always()
      run: |
        rm -rf ./artifact
        rm -rf ./bin
        rm -rf ./build_dir
