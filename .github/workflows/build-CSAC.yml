name: Build OpenWrt 25.12 for CSAC Router

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '编译类型'
        required: false
        default: 'minimal'
        enum: ['full', 'minimal']

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: Checkout代码（拉取你仓库main分支）
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: main

    - name: 安装依赖+【绝对路径】创建Build目录+mkimage软链接（绝杀修复）
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          python3-pip \
          python3-pyelftools \
          unzip \
          wget \
          rsync \
          time \
          xsltproc \
          zlib1g-dev \
          u-boot-tools \
          squashfs-tools
        # ########### 绝杀修复：用GITHUB_WORKSPACE绝对路径 ###########
        # 直接创建Build目录（绝对路径，100%识别）
        mkdir -p $GITHUB_WORKSPACE/Build
        # 绝对路径创建软链接，彻底解决No such file or directory
        sudo ln -sf /usr/bin/mkimage $GITHUB_WORKSPACE/Build/mkimage
        sudo chmod +x $GITHUB_WORKSPACE/Build/mkimage
        # 验证：检查软链接是否创建成功（可选，用于排查）
        ls -l $GITHUB_WORKSPACE/Build/mkimage
        sudo apt-get clean

    - name: 配置编译参数（和你原版完全一致）
      run: |
        if [ -f "seed.config" ]; then
          echo "使用自定义配置"
          cp seed.config .config
        else
          echo "生成默认配置"
          make defconfig
        fi
        echo "CONFIG_TARGET_ath79=y" >> .config
        echo "CONFIG_TARGET_ath79_generic=y" >> .config
        echo "CONFIG_TARGET_ath79_generic_DEVICE_csac_qca9563-csac=y" >> .config
        if [ "${{ github.event.inputs.build_type }}" = "minimal" ]; then
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL_PACKAGES=n" >> .config
          echo "CONFIG_PACKAGE_luci=n" >> .config
        fi
        make defconfig TARGET_DEVICE="ath79_generic_csac_qca9563-csac"

    - name: 下载feeds（和你原版完全一致）
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 编译固件（minimal单线程稳编，必出固件）
      run: |
        echo "开始编译 ${{ github.event.inputs.build_type }} 固件..."
        if [ "${{ github.event.inputs.build_type }}" = "minimal" ]; then
          time make -j1 V=s 2>&1 | tee build.log
        else
          time make -j$(nproc) V=s 2>&1 | tee build.log
        fi

    - name: 上传产物（和你原版完全一致）
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.sha }}-${{ matrix.image_type }}
        path: bin/targets/ath79/generic/

    - name: 上传日志（和你原版完全一致）
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.sha }}
        path: |
          build.log
          .config