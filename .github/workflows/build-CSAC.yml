name: Build OpenWrt 25.12

on:
  workflow_dispatch:
    inputs:
      build_options:
        description: 'é¢å¤–ç¼–è¯‘é€‰é¡¹ (å¯é€‰)'
        required: false
        default: ''
  push:
    branches: ["main", "master"]
  schedule:
    - cron: '0 2 * * 1'

env:
  TARGET: ath79
  SUBTARGET: generic
  DEVICE: csac_qca9563-csac
  BRANCH: main
  IMAGE_SIZE: 7808

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.BRANCH }}

    - name: éªŒè¯è®¾å¤‡æ ‘æ–‡ä»¶
      id: verify_dts
      run: |
        echo "æ£€æŸ¥è®¾å¤‡æ ‘æ–‡ä»¶..."
        if [ -f "target/linux/ath79/dts/qca9563_csac.dts" ]; then
          echo "âœ… æ‰¾åˆ°è®¾å¤‡æ ‘æ–‡ä»¶: qca9563_csac.dts"
          echo "dts_valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°è®¾å¤‡æ ‘æ–‡ä»¶ qca9563_csac.dts"
          echo "è¯·ç¡®ä¿åœ¨ target/linux/ath79/dts/ ç›®å½•ä¸‹æœ‰è¯¥æ–‡ä»¶"
          ls -la target/linux/ath79/dts/ || echo "è®¾å¤‡æ ‘ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          python3-pip \
          python3-pyelftools \
          unzip \
          wget \
          rsync \
          time \
          xsltproc \
          zlib1g-dev \
          subversion \
          gperf \
          bison \
          flex \
          asciidoc \
          bash \
          bc \
          binutils \
          bzip2 \
          diffutils \
          findutils \
          libc6-dev \
          libtool \
          make \
          patch \
          perl \
          ruby \
          sed \
          tar \
          xmlto \
          xxd \
          cmake \
          pkg-config \
          zip unzip jq

    - name: é…ç½®ç¼–è¯‘å‚æ•°
      run: |
        # å¦‚æžœå­˜åœ¨ seed.config åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
        if [ -f "seed.config" ]; then
          echo "ä½¿ç”¨è‡ªå®šä¹‰çš„ seed.config é…ç½®æ–‡ä»¶"
          cp seed.config .config
        else
          echo "seed.config ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          # è®¾ç½®åŸºæœ¬é…ç½®
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" > .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE }}=y" >> .config
        fi

        # å¼ºåˆ¶å¯ç”¨è®¾å¤‡æ ‘è¦†ç›–
        echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        # é•œåƒå¤§å°ç›´æŽ¥ä½¿ç”¨æ•°å­—ï¼Œæ— ä»»ä½•è¯­æ³•å¤„ç†ï¼ˆå½»åº•ä¿®å¤å˜é‡é”™è¯¯ï¼‰
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.IMAGE_SIZE }}" >> .config
        
        # å¦‚æžœéœ€è¦æ·»åŠ é¢å¤–é€‰é¡¹
        if [ -n "${{ github.event.inputs.build_options }}" ]; then
          echo "${{ github.event.inputs.build_options }}" >> .config
        fi

    - name: ä¸‹è½½ feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: é…ç½®ç¼–è¯‘é€‰é¡¹
      run: |
        # ä½¿ç”¨çŽ°æœ‰é…ç½®
        make defconfig
        echo "é…ç½®å®Œæˆï¼Œå¼€å§‹ç¼–è¯‘..."

    - name: å¼€å§‹ç¼–è¯‘
      run: |
        echo "å¼€å§‹ç¼–è¯‘ ${{ env.DEVICE }}..."
        time make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æžœ
      id: check_firm
      run: |
        BIN_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        if [ -d "$BIN_DIR" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ï¼š"
          find "$BIN_DIR" -name "*.bin" -o -name "*.img" -o -name "*.gz" | while read file; do
            echo "- $(basename "$file")"
            ls -lh "$file"
          done
          # æ£€æŸ¥initramfså›ºä»¶
          if find "$BIN_DIR" -name "*initramfs-kernel.bin" | grep -q .; then
            echo "âœ… å·²æˆåŠŸç”Ÿæˆ initramfs-kernel.bin å›ºä»¶ï¼"
          else
            echo "âš ï¸  æœªç”Ÿæˆ initramfs-kernel.bin ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æ ‘/é•œåƒé…ç½®"
          fi
          echo "FIRMWARE_DIR=$BIN_DIR" >> $GITHUB_ENV
        else
          echo "âŒ é”™è¯¯ï¼šç¼–è¯‘å¤±è´¥ï¼Œ$BIN_DIR ç›®å½•ä¸å­˜åœ¨"
          echo "æ˜¾ç¤ºç¼–è¯‘æ—¥å¿—çš„æœ€åŽ200è¡Œï¼š"
          tail -200 build.log
          exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ env.DEVICE }}-${{ github.sha }}-${{ matrix.image_type }}
        path: ${{ env.FIRMWARE_DIR }}/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.sha }}
        path: |
          build.log
          .config
        retention-days: 7

    - name: é€šçŸ¥ç»“æžœ
      if: always()
      run: |
        if [ -d "${{ env.FIRMWARE_DIR }}" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "å¯ä»¥åœ¨ Artifacts ä¸­æ‰¾åˆ°ç¼–è¯‘å¥½çš„å›ºä»¶ã€‚"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥ build.log æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯ã€‚"
          exit 1
        fi

    # ===== ä»…æ–°å¢žï¼šæœ€ç®€WeTransferå…è´¹ä¸Šä¼ ï¼ˆ7å¤©æœ‰æ•ˆï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸å½±å“æ ¸å¿ƒç¼–è¯‘ï¼‰=====
    - name: åŽ‹ç¼©å›ºä»¶+æ—¥å¿—ï¼ˆç”¨äºŽWeTransferä¸Šä¼ ï¼‰
      if: steps.check_firm.outcome == 'success'
      run: |
        mkdir -p csac_upload
        cp -r ${{ env.FIRMWARE_DIR }}/* csac_upload/
        cp build.log .config csac_upload/
        zip -r csac_openwrt_$(date +%Y%m%d).zip csac_upload/

    - name: ä¸Šä¼ åˆ°WeTransferå…è´¹ç‰ˆï¼ˆ7å¤©æœ‰æ•ˆï¼Œä»…åŽŸç”Ÿcurlï¼Œæ— ä»»ä½•ä¾èµ–ï¼‰
      if: steps.check_firm.outcome == 'success'
      run: |
        FILE="csac_openwrt_$(date +%Y%m%d).zip"
        # æœ€ç®€ä¸Šä¼ å‘½ä»¤ï¼Œç›´æŽ¥ç”Ÿæˆ7å¤©æœ‰æ•ˆé“¾æŽ¥
        RESP=$(curl -s -F "file=@$FILE" https://wetransfer.com/api/v1/transfers | jq -r '.url')
        echo "ðŸŽ‰ WeTransferå…è´¹ä¸‹è½½é“¾æŽ¥ï¼ˆ7å¤©æœ‰æ•ˆï¼‰ï¼š$RESP"
        echo "ä¸‹è½½é“¾æŽ¥ï¼š$RESP" >> $GITHUB_ENV