name: Build OpenWrt 25.12 (CSAC专用)

on:
  workflow_dispatch:
    inputs:
      build_options:
        description: '额外编译选项 (可选)'
        required: false
        default: ''
  push:
    branches: ["main", "master"]
  schedule:
    - cron: '0 2 * * 1'

env:
  TARGET: ath79
  SUBTARGET: generic
  DEVICE: csac_qca9563-csac
  BRANCH: main
  IMAGE_SIZE: 7808k  # 8MB闪存适配，保留k后缀，后续在Shell中处理

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.BRANCH }}

    - name: 验证设备树文件
      id: verify_dts
      run: |
        echo "检查设备树文件..."
        DTS_PATH="target/linux/ath79/dts/qca9563_csac.dts"
        if [ -f "$DTS_PATH" ]; then
          echo "✅ 找到设备树文件: $DTS_PATH"
          echo "dts_valid=true" >> $GITHUB_OUTPUT
        else
          echo "❌ 未找到设备树文件 $DTS_PATH"
          ls -la target/linux/ath79/dts/ || exit 1
          exit 1
        fi

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev python3 python3-distutils python3-setuptools python3-pip \
          python3-pyelftools unzip wget rsync time xsltproc zlib1g-dev \
          subversion gperf bison flex asciidoc bash bc binutils bzip2 \
          diffutils findutils libc6-dev libtool make patch perl ruby sed \
          tar xmlto xxd cmake pkg-config zip unzip

    - name: 配置编译参数（处理镜像大小变量）
      run: |
        # 1. 处理IMAGE_SIZE，去掉末尾的k，得到数字
        ROOTFS_SIZE="${{ env.IMAGE_SIZE }}"
        ROOTFS_SIZE="${ROOTFS_SIZE%k}"
        
        # 2. 加载配置
        if [ -f "seed.config" ]; then
          echo "使用自定义seed.config"
          cp seed.config .config
        else
          echo "使用默认配置"
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" > .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE }}=y" >> .config
        fi
        
        # 3. 追加必要配置
        echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${ROOTFS_SIZE}" >> .config
        
        # 4. 追加额外选项
        if [ -n "${{ github.event.inputs.build_options }}" ]; then
          echo "${{ github.event.inputs.build_options }}" >> .config
        fi

    - name: 下载feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成编译配置
      run: |
        make defconfig
        echo "编译配置生成完成"

    - name: 开始编译
      run: |
        echo "开始编译 ${{ env.DEVICE }}..."
        if ! time make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log; then
          echo "⚠️  多线程编译失败，切换单线程..."
          time make -j1 V=s 2>&1 | tee -a build.log
          exit 1
        fi

    - name: 检查编译结果
      id: check_firm
      run: |
        BIN_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        # 查找固件目录
        if [ ! -d "$BIN_DIR" ] || [ -z "$(find $BIN_DIR -name "*.bin")" ]; then
          BIN_DIR=$(find build_dir/target-mips_24kc_musl/linux-ath79_generic/tmp -name "*.bin" | xargs -n1 dirname | head -1)
          if [ -z "$BIN_DIR" ]; then
            echo "❌ 未找到固件，打印日志..."
            tail -200 build.log
            exit 1
          fi
        fi
        echo "✅ 固件目录: $BIN_DIR"
        echo "FIRMWARE_DIR=$BIN_DIR" >> $GITHUB_ENV

    - name: 上传固件到WeTransfer（7天有效）
      if: steps.check_firm.outcome == 'success'
      uses: kittinan/transfer-we@v1
      with:
        filename: ${{ env.FIRMWARE_DIR }}
        title: "CSAC-OpenWrt固件"

    - name: 上传编译日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        retention-days: 7

    - name: 输出结果
      if: always()
      run: |
        if [ -n "${{ env.FIRMWARE_DIR }}" ]; then
          echo "✅ 编译成功！WeTransfer链接见上方步骤"
        else
          echo "❌ 编译失败，请查看日志"
          exit 1
        fi