name: Build OpenWrt 25.12 (CSACä¸“å±Â·å…œåº•å¿…æˆç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      build_options:
        description: 'é¢å¤–ç¼–è¯‘é€‰é¡¹ (å¯é€‰)'
        required: false
        default: ''
  push:
    branches: ["main", "master"]

env:
  TARGET: ath79
  SUBTARGET: generic
  DEVICE: csac_qca9563-csac
  BRANCH: main
  IMAGE_SIZE: 7808

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    steps:
    - name: æ£€å‡º25.12ä¸»ä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.BRANCH }}

    - name: éªŒè¯CSACè®¾å¤‡æ ‘&åˆ›æ ¸å¿ƒç›®å½•
      run: |
        # éªŒè¯è®¾å¤‡æ ‘
        DTS_PATH="target/linux/ath79/dts/qca9563_csac.dts"
        if [ ! -f "$DTS_PATH" ]; then
          echo "âŒ æœªæ‰¾åˆ°CSACè®¾å¤‡æ ‘ï¼š$DTS_PATH"
          exit 1
        fi
        echo "âœ… éªŒè¯CSACè®¾å¤‡æ ‘æˆåŠŸ"
        # æå‰åˆ›å»ºå›ºä»¶è¾“å‡ºç›®å½•ï¼Œè§£å†³No such file or directory
        mkdir -p bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}
        mkdir -p build_dir/target-mips_24kc_musl/linux-ath79_generic/tmp
        echo "âœ… æå‰åˆ›å»ºæ‰€æœ‰ç¼–è¯‘/è¾“å‡ºç›®å½•ï¼Œé¿å…ç›®å½•ç¼ºå¤±"

    - name: å®‰è£…25.12ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆæ— æƒé™é—®é¢˜ï¼‰
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache gawk gettext git libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils rsync time \
          unzip wget zlib1g-dev bison flex bash bc binutils bzip2 make patch \
          sed tar xxd pkg-config u-boot-tools jq
        sudo apt-get clean

    - name: å±è”½æ— ç”¨feeds&ä»…åŠ è½½ç³»ç»Ÿæ ¸å¿ƒä¾èµ–
      run: |
        echo > feeds.conf.default
        ./scripts/feeds update -f -i
        ./scripts/feeds install -f -i base
        echo "âœ… ä»…åŠ è½½ç³»ç»Ÿæ ¸å¿ƒfeedsï¼Œæ— ç¬¬ä¸‰æ–¹ä¾èµ–è­¦å‘Š"

    - name: é…ç½®CSACä¸“å±ç¼–è¯‘å‚æ•°ï¼ˆçº¯å›ºä»¶ï¼Œæ— å¤šä½™åŒ…ï¼‰
      run: |
        > .config
        # æ ¸å¿ƒè®¾å¤‡é…ç½®
        echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE }}=y" >> .config
        echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.IMAGE_SIZE }}" >> .config
        # å½»åº•ç¦ç”¨å¤šä½™åŒ…
        echo "CONFIG_ALL=n" >> .config
        echo "CONFIG_ALL_KMODS=n" >> .config
        echo "CONFIG_ALL_PACKAGES=n" >> .config
        echo "CONFIG_PACKAGE_luci=n" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        # è‡ªå®šä¹‰é€‰é¡¹
        if [ -n "${{ github.event.inputs.build_options }}" ]; then
          echo "${{ github.event.inputs.build_options }}" >> .config
        fi
        make defconfig V=s
        echo "âœ… CSACä¸“å±ç¼–è¯‘é…ç½®ç”Ÿæˆå®Œæˆ"

    - name: å‰ç½®æ­¥éª¤ï¼šä¸‹è½½å†…æ ¸/å·¥å…·é“¾ï¼ˆ25.12å¿…åŠ ï¼Œå¦åˆ™ç¼ºä¾èµ–ï¼‰
      run: |
        echo "ğŸ“¥ ä¸‹è½½25.12å†…æ ¸ã€å·¥å…·é“¾ç­‰ç¼–è¯‘ä¾èµ–..."
        time make download -j$(nproc) V=s 2>&1 | tee download.log
        echo "âœ… æ‰€æœ‰ç¼–è¯‘ä¾èµ–ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘CSACå†…æ ¸&é©±åŠ¨ï¼ˆå›ºä»¶å‰ç½®æ ¸å¿ƒæ­¥éª¤ï¼‰
      run: |
        echo "âš™ï¸  ç¼–è¯‘CSACä¸“å±å†…æ ¸&é©±åŠ¨..."
        time make target/linux/compile V=s 2>&1 | tee kernel.log
        echo "âœ… CSACå†…æ ¸&é©±åŠ¨ç¼–è¯‘å®Œæˆ"

    - name: ç¼–è¯‘CSAC 25.12ä¸“å±å›ºä»¶ï¼ˆ25.12å…œåº•å‘½ä»¤ï¼Œå¿…å‡ºbinï¼‰
      run: |
        echo "ğŸ‰ å¼€å§‹ç¼–è¯‘CSAC 25.12ä¸“å±å›ºä»¶ï¼Œå…¨ç¨‹ä»…ç¼–è¯‘å½“å‰è®¾å¤‡ï¼"
        # 25.12å…œåº•ç¼–è¯‘å‘½ä»¤ï¼Œè¦†ç›–æ‰€æœ‰å›ºä»¶ç”Ÿæˆé€»è¾‘
        time make target/linux/install V=s 2>&1 | tee firmware.log
        echo "âœ… CSACå›ºä»¶ç¼–è¯‘å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥è¾“å‡º"

    - name: å…¨å±€æŸ¥æ‰¾CSACå›ºä»¶ï¼ˆå…œåº•æŸ¥æ‰¾ï¼Œæ— è§†ç›®å½•å±‚çº§ï¼‰
      id: find_csac
      run: |
        # å…¨å±€æŸ¥æ‰¾CSACä¸“å±binå›ºä»¶ï¼Œä¸ç®¡åœ¨å“ªä¸ªç›®å½•
        CSAC_FIRM=$(find . -name "*${{ env.DEVICE }}*.bin" -type f | head -1)
        if [ -z "$CSAC_FIRM" ]; then
          echo "âŒ å…¨å±€æœªæ‰¾åˆ°CSACå›ºä»¶ï¼Œæ‰“å°å…³é”®ç¼–è¯‘æ—¥å¿—ï¼š"
          cat kernel.log firmware.log | grep -E "csac|${{ env.DEVICE }}|error|fail|mkimage"
          exit 1
        fi
        # å¤åˆ¶å›ºä»¶åˆ°æ ‡å‡†ç›®å½•ï¼Œæ–¹ä¾¿ä¸Šä¼ 
        cp "$CSAC_FIRM" bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/
        CSAC_FIRM_STD="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/$(basename $CSAC_FIRM)"
        # æ‰“å°å›ºä»¶è¯¦ç»†ä¿¡æ¯
        ls -lh "$CSAC_FIRM_STD"
        file "$CSAC_FIRM_STD"
        echo "CSAC_FIRM=$CSAC_FIRM_STD" >> $GITHUB_ENV
        echo "âœ… æ‰¾åˆ°CSAC 25.12ä¸“å±å›ºä»¶ï¼š$CSAC_FIRM_STD"

    - name: ä¸Šä¼ CSAC 25.12ä¸“å±å›ºä»¶ï¼ˆå¿…ä¼ æˆåŠŸï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: CSAC-OpenWrt25.12-æœ€ç»ˆå›ºä»¶
        path: ${{ env.CSAC_FIRM }}
        retention-days: 90

    - name: ä¸Šä¼ æ‰€æœ‰ç¼–è¯‘æ—¥å¿—ï¼ˆæ–¹ä¾¿æ’æŸ¥ï¼‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: CSAC-å…¨é‡ç¼–è¯‘æ—¥å¿—
        path: |
          build.log
          download.log
          kernel.log
          firmware.log
        retention-days: 7