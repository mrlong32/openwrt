name: Build OpenWrt 25.12 for CSAC Router

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '编译类型'
        required: false
        default: 'minimal'
        enum: ['full', 'minimal']

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: Checkout代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: openwrt-25.12

    - name: 安装依赖（补mkimage+squashfs工具，核心修复）
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          python3-pip \
          python3-pyelftools \
          unzip \
          wget \
          rsync \
          time \
          xsltproc \
          zlib1g-dev \
          u-boot-tools \
          squashfs-tools  # 新增：解决squashfs打包警告
        # 核心修复：创建mkimage软链接，映射到OpenWrt识别的Build目录
        sudo ln -sf /usr/bin/mkimage $(pwd)/Build/mkimage
        sudo chmod +x $(pwd)/Build/mkimage
        sudo apt-get clean

    - name: 配置编译参数
      run: |
        if [ -f "seed.config" ]; then
          echo "使用自定义配置"
          cp seed.config .config
        else
          echo "生成默认配置"
          make defconfig
        fi
        echo "CONFIG_TARGET_ath79=y" >> .config
        echo "CONFIG_TARGET_ath79_generic=y" >> .config
        echo "CONFIG_TARGET_ath79_generic_DEVICE_csac_qca9563-csac=y" >> .config
        if [ "${{ github.event.inputs.build_type }}" = "minimal" ]; then
          echo "CONFIG_ALL=n" >> .config
          echo "CONFIG_ALL_KMODS=n" >> .config
          echo "CONFIG_ALL_PACKAGES=n" >> .config
          echo "CONFIG_PACKAGE_luci=n" >> .config
        fi
        make defconfig TARGET_DEVICE="ath79_generic_csac_qca9563-csac"

    - name: 下载feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 编译固件（mkimage已就绪，可正常打包）
      run: |
        echo "开始编译 ${{ github.event.inputs.build_type }} 固件..."
        if [ "${{ github.event.inputs.build_type }}" = "minimal" ]; then
          time make -j1 V=s 2>&1 | tee build.log
        else
          time make -j$(nproc) V=s 2>&1 | tee build.log
        fi

    - name: 上传产物（包含CSAC专属bin固件）
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.sha }}-${{ matrix.image_type }}
        path: bin/targets/ath79/generic/

    - name: 上传日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.sha }}
        path: |
          build.log
          .config