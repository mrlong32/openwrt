name: Build OpenWrt 25.12 (ä»…ç¼–è¯‘CSAC)

on:
  workflow_dispatch:
    inputs:
      build_options:
        description: 'é¢å¤–ç¼–è¯‘é€‰é¡¹ (å¯é€‰)'
        required: false
        default: ''
  push:
    branches: ["main", "master"]
  schedule:
    - cron: '0 2 * * 1'

env:
  TARGET: ath79
  SUBTARGET: generic
  DEVICE: csac_qca9563-csac  # ä½ çš„è®¾å¤‡åï¼Œå…¨ç¨‹å¤ç”¨
  BRANCH: main
  IMAGE_SIZE: 7808

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.BRANCH }}

    - name: éªŒè¯CSACè®¾å¤‡æ ‘ï¼ˆåªæ£€æŸ¥ä½ çš„è®¾å¤‡ï¼‰
      id: verify_dts
      run: |
        DTS_PATH="target/linux/ath79/dts/qca9563_csac.dts"
        if [ -f "$DTS_PATH" ]; then
          echo "âœ… æ‰¾åˆ°CSACè®¾å¤‡æ ‘: $DTS_PATH"
          echo "dts_valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ æœªæ‰¾åˆ°CSACè®¾å¤‡æ ‘ $DTS_PATH"
          exit 1
        fi

    - name: å®‰è£…ç¼–è¯‘ç¯å¢ƒï¼ˆè¡¥å…¨æ‰€æœ‰è‡´å‘½ä¾èµ–ï¼Œå«mkimageï¼‰
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          libelf-dev libncurses5-dev libncursesw5-dev libssl-dev \
          python3 python3-distutils python3-setuptools python3-pip \
          unzip wget rsync time xsltproc zlib1g-dev subversion gperf \
          bison flex asciidoc bash bc binutils bzip2 diffutils findutils \
          libc6-dev libtool make patch perl ruby sed tar xmlto xxd cmake \
          pkg-config zip unzip jq \
          u-boot-tools  # å¿…è£…ï¼è§£å†³Missing mkimageçš„æ ¸å¿ƒä¾èµ–

    - name: ä¿®å¤feedsæºï¼ˆæç®€ï¼Œä»…æ‹‰å–æ ¸å¿ƒä¾èµ–ï¼ŒåŠ å¿«ç¼–è¯‘ï¼‰
      run: |
        mv feeds.conf.default feeds.conf.default.bak
        cat > feeds.conf.default << EOF
        src-git packages https://github.com/openwrt/packages.git openwrt-23.05
        EOF
        ./scripts/feeds update -f -a
        ./scripts/feeds install -f -a

    - name: é…ç½®ç¼–è¯‘å‚æ•°ï¼ˆåŸºç¡€é…ç½®ï¼‰
      run: |
        # åŸºç¡€é…ç½®ï¼ŒåªæŒ‡å®šæ¶æ„
        echo "CONFIG_TARGET_${{ env.TARGET }}=y" > .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
        echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.IMAGE_SIZE }}" >> .config
        # è¿½åŠ è‡ªå®šä¹‰é€‰é¡¹
        if [ -n "${{ env.INPUT_BUILD_OPTIONS }}" ]; then
          echo "${{ env.INPUT_BUILD_OPTIONS }}" >> .config
        fi

    # ==============================================
    # æ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼å¼ºåˆ¶æŒ‡å®šä»…ç¼–è¯‘ä½ çš„CSACè®¾å¤‡ï¼Œè·³è¿‡æ‰€æœ‰å…¶ä»–è®¾å¤‡
    # ==============================================
    - name: å¼ºåˆ¶æŒ‡å®šä»…ç¼–è¯‘CSACè®¾å¤‡ï¼ˆè§£å†³æ— CSACæ—¥å¿—çš„å…³é”®ï¼‰
      run: |
        make defconfig TARGET_DEVICE="${{ env.TARGET }}_${{ env.SUBTARGET }}_${{ env.DEVICE }}"
        echo "âœ… å·²å¼ºåˆ¶æŒ‡å®šï¼Œæœ¬æ¬¡ä»…ç¼–è¯‘CSACè®¾å¤‡ï¼š${{ env.DEVICE }}"

    - name: ç¼–è¯‘CSACä¸“å±å›ºä»¶ï¼ˆå…¨ç¨‹åªç¼–è¯‘CSACï¼Œæ— å…¶ä»–è®¾å¤‡ï¼‰
      run: |
        echo "å¼€å§‹ç¼–è¯‘CSACå›ºä»¶ï¼Œæ—¥å¿—ä»…æ˜¾ç¤ºCSACç›¸å…³ä¿¡æ¯..."
        # å¼ºåˆ¶æŒ‡å®šè®¾å¤‡+ä»…ç”Ÿæˆå›ºä»¶+å¤šçº¿ç¨‹ï¼Œæ— ä»»ä½•å¤šä½™ç¼–è¯‘
        time make image TARGET_DEVICE="${{ env.TARGET }}_${{ env.SUBTARGET }}_${{ env.DEVICE }}" -j$(nproc) V=s 2>&1 | tee build.log

    - name: æ£€æŸ¥CSACå›ºä»¶ï¼ˆåªæ‰¾CSACçš„binæ–‡ä»¶ï¼Œç²¾å‡†å®šä½ï¼‰
      id: check_csac_firm
      run: |
        BIN_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        # åªè¿‡æ»¤CSACç›¸å…³çš„å›ºä»¶æ–‡ä»¶
        CSAC_FIRM=$(find "$BIN_DIR" -name "*${{ env.DEVICE }}*.bin")
        if [ -n "$CSAC_FIRM" ]; then
          echo "âœ… CSACå›ºä»¶ç”ŸæˆæˆåŠŸï¼æ–‡ä»¶ï¼š"
          ls -lh $CSAC_FIRM
          echo "CSAC_FIRM=$CSAC_FIRM" >> $GITHUB_ENV
          echo "FIRMWARE_DIR=$BIN_DIR" >> $GITHUB_ENV
        else
          echo "âŒ æœªæ‰¾åˆ°CSACå›ºä»¶ï¼Œæ‰“å°æœ€å200è¡Œæ—¥å¿—ï¼š"
          tail -200 build.log
          exit 1
        fi

    - name: ä¸Šä¼ CSACä¸“å±å›ºä»¶ï¼ˆä»…ä¼ CSACçš„binæ–‡ä»¶ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: CSAC-OpenWrtå›ºä»¶
        path: ${{ env.CSAC_FIRM }}
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—ï¼ˆæ–¹ä¾¿æ’æŸ¥ï¼‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: CSAC-ç¼–è¯‘æ—¥å¿—
        path: build.log
        retention-days: 7

    - name: æœ€ç»ˆç»“æœé€šçŸ¥
      if: always()
      run: |
        if [ -n "${{ env.CSAC_FIRM }}" ]; then
          echo "ğŸ‰ CSACå›ºä»¶ç¼–è¯‘æˆåŠŸï¼å¯åœ¨Artifactsä¸‹è½½ä¸“å±binæ–‡ä»¶"
        else
          echo "âŒ CSACå›ºä»¶ç¼–è¯‘å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          exit 1
        fi