name: Build OpenWrt 25.12 for CSAC Router

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '编译类型'
        required: false
        default: 'minimal'
        enum: ['full', 'minimal']

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: Checkout代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: main

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          python3-pip \
          python3-pyelftools \
          unzip \
          wget \
          rsync \
          time \
          xsltproc \
          zlib1g-dev
    - name: 配置编译参数
      run: |
        # 加载自定义配置
        if [ -f "seed.config" ]; then
          echo "使用自定义配置"
          cp seed.config .config
        else
          echo "生成默认配置"
          make defconfig
        fi
        # 应用设备树
        echo "CONFIG_TARGET_ath79=y" >> .config
        echo "CONFIG_TARGET_ath79_generic=y" >> .config
        echo "CONFIG_TARGET_ath79_generic_DEVICE_csac_qca9563-csac=y" >> .config
    - name: 下载feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    - name: 编译固件
      run: |
        echo "开始编译 ${{ github.event.inputs.build_type }} 固件..."
        time make -j$(nproc) V=s 2>&1 | tee build.log
    - name: 上传产物
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.sha }}-${{ matrix.image_type }}
        path: bin/targets/ath79/generic/

    - name: 上传日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.sha }}
        path: |
          build.log
          .config
