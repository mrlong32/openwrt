name: Build OpenWrt 25.12

on:
  workflow_dispatch:
    inputs:
      build_options:
        description: 'é¢å¤–ç¼–è¯‘é€‰é¡¹ (å¯é€‰)'
        required: false
        default: ''
  push:
    branches: ["main", "master"]
  schedule:
    - cron: '0 2 * * 1'

env:
  TARGET: ath79
  SUBTARGET: generic
  DEVICE: csac_qca9563-csac
  BRANCH: main
  IMAGE_SIZE: 7808k  # æ–°å¢ï¼šå…¨å±€å®šä¹‰é•œåƒå¤§å°ï¼ŒåŒé‡ä¿éšœï¼ˆ8MBé—ªå­˜é€‚é…ï¼‰

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.BRANCH }}

    - name: éªŒè¯è®¾å¤‡æ ‘æ–‡ä»¶
      id: verify_dts
      run: |
        echo "æ£€æŸ¥è®¾å¤‡æ ‘æ–‡ä»¶..."
        if [ -f "target/linux/ath79/dts/qca9563_csac.dts" ]; then
          echo "âœ… æ‰¾åˆ°è®¾å¤‡æ ‘æ–‡ä»¶: qca9563_csac.dts"
          echo "dts_valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°è®¾å¤‡æ ‘æ–‡ä»¶ qca9563_csac.dts"
          echo "è¯·ç¡®ä¿åœ¨ target/linux/ath79/dts/ ç›®å½•ä¸‹æœ‰è¯¥æ–‡ä»¶"
          ls -la target/linux/ath79/dts/ || echo "è®¾å¤‡æ ‘ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-setuptools \
          python3-pip \
          python3-pyelftools \
          unzip \
          wget \
          rsync \
          time \
          xsltproc \
          zlib1g-dev \
          subversion \
          gperf \
          bison \
          flex \
          asciidoc \
          bash \
          bc \
          binutils \
          bzip2 \
          diffutils \
          findutils \
          libc6-dev \
          libtool \
          make \
          patch \
          perl \
          ruby \
          sed \
          tar \
          xmlto \
          xxd \
          cmake \
          pkg-config

    # æ–°å¢æ­¥éª¤ï¼šå½»åº•æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼ˆäº‘ç¼–è¯‘æ ¸å¿ƒï¼Œé¿å…æ—§é…ç½®/æ–‡ä»¶æ®‹ç•™ï¼‰
    - name: å½»åº•æ¸…ç†ç¼–è¯‘ç¼“å­˜
      run: |
        echo "ğŸ—‘ï¸  æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼Œé¿å…æ—§é…ç½®å¹²æ‰°..."
        make clean && make dirclean
        rm -rf build_dir/target-* tmp/  # é¢å¤–æ¸…ç†äº‘ç«¯æ®‹ç•™çš„ç›®æ ‡ç›®å½•
        echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

    - name: é…ç½®ç¼–è¯‘å‚æ•°
      run: |
        # å¦‚æœå­˜åœ¨ seed.config åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
        if [ -f "seed.config" ]; then
          echo "ä½¿ç”¨è‡ªå®šä¹‰çš„ seed.config é…ç½®æ–‡ä»¶"
          cp seed.config .config
          # æ–°å¢ï¼šåœ¨seed.configåè¿½åŠ é•œåƒå¤§å°ï¼ŒåŒé‡ä¿éšœï¼ˆè§£å†³é•œåƒè¿‡å¤§æ ¸å¿ƒé—®é¢˜ï¼‰
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.IMAGE_SIZE%k }}" >> .config
        else
          echo "seed.config ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          # è®¾ç½®åŸºæœ¬é…ç½®
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" > .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE }}=y" >> .config
          # æ–°å¢ï¼šé»˜è®¤é…ç½®ä¹Ÿè¿½åŠ é•œåƒå¤§å°å’Œè®¾å¤‡æ ‘è¦†ç›–
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.IMAGE_SIZE%k }}" >> .config
          echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        fi

        # å¼ºåˆ¶å¯ç”¨è®¾å¤‡æ ‘è¦†ç›–
        echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        
        # å¦‚æœéœ€è¦æ·»åŠ é¢å¤–é€‰é¡¹
        if [ -n "${{ github.event.inputs.build_options }}" ]; then
          echo "${{ github.event.inputs.build_options }}" >> .config
        fi

    - name: ä¸‹è½½ feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: é…ç½®ç¼–è¯‘é€‰é¡¹
      run: |
        # ä½¿ç”¨ç°æœ‰é…ç½®å¹¶è‡ªåŠ¨è¡¥å…¨ä¾èµ–
        make defconfig
        echo "âœ… é…ç½®å®Œæˆï¼Œå¼€å§‹é¢„ä¸‹è½½ä¾èµ–åŒ…..."

    # æ–°å¢æ­¥éª¤ï¼šæå‰ä¸‹è½½æ‰€æœ‰ç¼–è¯‘ä¾èµ–åŒ…ï¼ˆäº‘ç¼–è¯‘æ ¸å¿ƒï¼Œé¿å…ç¼–è¯‘ä¸­ç¼ºåŒ…/æ–­ç½‘ï¼‰
    - name: æå‰ä¸‹è½½æ‰€æœ‰ä¾èµ–åŒ…
      run: |
        FORCE_UNSAFE_CONFIGURE=1 make download -j$(nproc)
        # æ¸…ç†ä¸‹è½½ç›®å½•çš„ç©ºæ–‡ä»¶/å°æ–‡ä»¶ï¼ˆé¿å…ç¼–è¯‘æ—¶è¯†åˆ«é”™è¯¯ï¼‰
        find dl -size -1024c -delete
        echo "âœ… æ‰€æœ‰ä¾èµ–åŒ…ä¸‹è½½å®Œæˆï¼Œå…±$(ls dl | wc -l)ä¸ªåŒ…"

    - name: å¼€å§‹ç¼–è¯‘
      run: |
        # ä¼˜åŒ–ï¼šå…ˆå¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥åˆ™è‡ªåŠ¨å•çº¿ç¨‹æ‰“å°è¯¦ç»†æ—¥å¿—ï¼ˆæ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼‰
        echo "å¼€å§‹ç¼–è¯‘ ${{ env.DEVICE }}... çº¿ç¨‹æ•°: $(($(nproc)+1))"
        if ! time make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log; then
          echo "âš ï¸  å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œåˆ‡æ¢ä¸ºå•çº¿ç¨‹é‡æ–°ç¼–è¯‘ï¼ˆæ‰“å°è¯¦ç»†æ—¥å¿—ï¼‰..."
          time make -j1 V=s 2>&1 | tee -a build.log
          exit 1
        fi

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
      run: |
        # æ£€æŸ¥å›ºä»¶æ˜¯å¦ç”Ÿæˆ
        BIN_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        if [ -d "$BIN_DIR" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ï¼š"
          find "$BIN_DIR" -name "*.bin" -o -name "*.img" -o -name "*.gz" | while read file; do
            echo "- $(basename "$file")"
            ls -lh "$file"
          done
          # æ–°å¢ï¼šéªŒè¯initramfså›ºä»¶æ˜¯å¦ç”Ÿæˆï¼ˆä½ éœ€è¦çš„æ ¸å¿ƒæ–‡ä»¶ï¼‰
          if find "$BIN_DIR" -name "*initramfs-kernel.bin" | grep -q .; then
            echo "âœ… å·²æˆåŠŸç”Ÿæˆ initramfs-kernel.bin å›ºä»¶ï¼"
          else
            echo "âš ï¸  æœªç”Ÿæˆ initramfs-kernel.bin ï¼Œè¯·æ£€æŸ¥è®¾å¤‡é…ç½®"
          fi
        else
          echo "âŒ é”™è¯¯ï¼šç¼–è¯‘å¤±è´¥ï¼Œ$BIN_DIR ç›®å½•ä¸å­˜åœ¨"
          # æ˜¾ç¤ºç¼–è¯‘æ—¥å¿—çš„æœ€å200è¡Œï¼ˆæ›´å¤šä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
          echo "æ˜¾ç¤ºç¼–è¯‘æ—¥å¿—çš„æœ€å200è¡Œï¼š"
          tail -200 build.log
          exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ env.DEVICE }}-${{ github.sha }}-${{ matrix.image_type }}
        path: bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-${{ github.sha }}
        path: |
          build.log
          .config
        retention-days: 7

    - name: é€šçŸ¥ç»“æœ
      if: always()
      run: |
        if [ -d "bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}" ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          echo "å¯ä»¥åœ¨ Artifacts ä¸­æ‰¾åˆ°ç¼–è¯‘å¥½çš„å›ºä»¶ï¼ˆå«initramfs-kernel.binï¼‰ã€‚"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥ build.log æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯ã€‚"
          exit 1
        fi