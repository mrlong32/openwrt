name: Build OpenWrt 25.12 (CSACä¸“å±Â·æœ€ç»ˆå¯è¿è¡Œç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      build_options:
        description: 'é¢å¤–ç¼–è¯‘é€‰é¡¹ (å¯é€‰)'
        required: false
        default: ''
  push:
    branches: ["main", "master"]

env:
  TARGET: ath79
  SUBTARGET: generic
  DEVICE: csac_qca9563-csac
  BRANCH: main
  IMAGE_SIZE: 7808

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    steps:
    - name: æ£€å‡º25.12ä¸»ä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.BRANCH }}

    - name: éªŒè¯CSACè®¾å¤‡æ ‘
      run: |
        DTS_PATH="target/linux/ath79/dts/qca9563_csac.dts"
        if [ ! -f "$DTS_PATH" ]; then
          echo "âŒ æœªæ‰¾åˆ°CSACè®¾å¤‡æ ‘ï¼š$DTS_PATH"
          exit 1
        fi
        echo "âœ… éªŒè¯CSACè®¾å¤‡æ ‘æˆåŠŸ"

    - name: å®‰è£…25.12ç¼–è¯‘æ ¸å¿ƒä¾èµ–ï¼ˆä»…è£…å¿…é¡»çš„ï¼Œå«mkimageï¼Œåˆ é™¤æƒé™æŠ¥é”™çš„æ¸…ç†ï¼‰
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache gawk gettext git libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils rsync time \
          unzip wget zlib1g-dev bison flex bash bc binutils bzip2 make patch \
          sed tar xxd pkg-config u-boot-tools jq
        # ä»…ä¿ç•™sudo apt-get cleanï¼Œåˆ æ‰rm -rf /var/lib/apt/lists/* è§£å†³æƒé™é”™è¯¯
        sudo apt-get clean

    - name: å½»åº•å±è”½æ— ç”¨feedsï¼ˆæ ¸å¿ƒï¼æ¶ˆé™¤æ‰€æœ‰ä¾èµ–è­¦å‘Šï¼Œçº¯å›ºä»¶ç¼–è¯‘æ— éœ€feedsï¼‰
      run: |
        # æ¸…ç©ºfeeds.confï¼Œä¸åŠ è½½ä»»ä½•ç¬¬ä¸‰æ–¹feedsï¼Œå½»åº•æ¶ˆé™¤ä¾èµ–è­¦å‘Š
        echo > feeds.conf.default
        # ä»…æ›´æ–°ç³»ç»Ÿå†…ç½®æ ¸å¿ƒfeedsï¼Œä¸å®‰è£…ä»»ä½•ç¬¬ä¸‰æ–¹åŒ…
        ./scripts/feeds update -f -i
        ./scripts/feeds install -f -i base

    - name: é…ç½®CSACä¸“å±ç¼–è¯‘å‚æ•°ï¼ˆç¦ç”¨æ‰€æœ‰å¤šä½™åŒ…ï¼Œçº¯å›ºä»¶ï¼‰
      run: |
        # åˆå§‹åŒ–ç©ºé…ç½®
        > .config
        # ä»…å¼€å¯CSACè®¾å¤‡ç›¸å…³é…ç½®ï¼Œå…¶ä½™å…¨å…³
        echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE }}=y" >> .config
        echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ env.IMAGE_SIZE }}" >> .config
        # å½»åº•ç¦ç”¨å…¨é‡åŒ…/å†…æ ¸æ¨¡å—/ç¬¬ä¸‰æ–¹åŒ…
        echo "CONFIG_ALL=n" >> .config
        echo "CONFIG_ALL_KMODS=n" >> .config
        echo "CONFIG_ALL_PACKAGES=n" >> .config
        echo "CONFIG_PACKAGE_luci=n" >> .config
        echo "CONFIG_PACKAGE_routing=n" >> .config
        # è¿½åŠ è‡ªå®šä¹‰é€‰é¡¹
        if [ -n "${{ github.event.inputs.build_options }}" ]; then
          echo "${{ github.event.inputs.build_options }}" >> .config
        fi
        # ç”Ÿæˆé…ç½®
        make defconfig V=s

    - name: ç¼–è¯‘CSAC 25.12ä¸“å±å›ºä»¶ï¼ˆ25.12å…¼å®¹target-imagesï¼Œå•çº¿ç¨‹ç¨³ç¼–ï¼‰
      run: |
        echo "ğŸ‰ å¼€å§‹ç¼–è¯‘CSAC 25.12ä¸“å±å›ºä»¶ï¼Œå…¨ç¨‹ä»…ç¼–è¯‘å½“å‰è®¾å¤‡ï¼"
        # 25.12ç”¨target-imagesæ›¿ä»£åŸimageï¼Œ-j1ç¨³ç¼–ï¼ŒV=sçœ‹è¯¦ç»†CSACæ—¥å¿—
        time make target-images -j1 V=s 2>&1 | tee build.log

    - name: æ£€æŸ¥å¹¶æå–CSACä¸“å±å›ºä»¶ï¼ˆç²¾å‡†è¿‡æ»¤ï¼Œåªæ‰¾ä½ çš„è®¾å¤‡binæ–‡ä»¶ï¼‰
      id: check_csac
      run: |
        BIN_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        # ç²¾å‡†åŒ¹é…CSACè®¾å¤‡å›ºä»¶ï¼Œé¿å…å…¶ä»–æ–‡ä»¶å¹²æ‰°
        CSAC_FIRM=$(find "$BIN_DIR" -maxdepth 1 -name "*${{ env.DEVICE }}*.bin" | head -1)
        if [ -z "$CSAC_FIRM" ]; then
          echo "âŒ æœªæ‰¾åˆ°CSACå›ºä»¶ï¼Œæ‰“å°æ ¸å¿ƒæ—¥å¿—ï¼š"
          grep -E "csac|${{ env.DEVICE }}|error|warn" build.log
          exit 1
        fi
        # æ‰“å°å›ºä»¶ä¿¡æ¯
        ls -lh "$CSAC_FIRM"
        echo "CSAC_FIRM=$CSAC_FIRM" >> $GITHUB_ENV
        echo "âœ… CSAC 25.12å›ºä»¶ç”ŸæˆæˆåŠŸï¼"

    - name: ä¸Šä¼ CSAC 25.12ä¸“å±å›ºä»¶ï¼ˆä»…ä¼ binæ–‡ä»¶ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: CSAC-OpenWrt25.12-å›ºä»¶
        path: ${{ env.CSAC_FIRM }}
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—ï¼ˆæ–¹ä¾¿æ’æŸ¥ï¼‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: CSAC-ç¼–è¯‘æ—¥å¿—
        path: build.log
        retention-days: 7