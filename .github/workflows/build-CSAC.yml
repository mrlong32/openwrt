name: Build OpenWrt 25.12 (CSACä¸“ç”¨)

on:
  workflow_dispatch:
    inputs:
      build_options:
        description: 'é¢å¤–ç¼–è¯‘é€‰é¡¹ (å¯é€‰)'
        required: false
        default: ''
  push:
    branches: ["main", "master"]
  schedule:
    - cron: '0 2 * * 1'

env:
  TARGET: ath79                  # å¼ºåˆ¶CSACè®¾å¤‡çš„ath79æ¶æ„
  SUBTARGET: generic             # å¼ºåˆ¶åŒ¹é…subtarget
  DEVICE: csac_qca9563-csac      # ä½ çš„CSACè®¾å¤‡å
  BRANCH: main
  IMAGE_SIZE: 7808k
  WETRANSFER_EXPIRY: 7d          # WeTransferå…è´¹ç‰ˆæœ‰æ•ˆæœŸ7å¤©

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.BRANCH }}

    - name: éªŒè¯è®¾å¤‡æ ‘æ–‡ä»¶ï¼ˆath79æ¶æ„ä¸“å±ï¼‰
      id: verify_dts
      run: |
        echo "æ£€æŸ¥ath79æ¶æ„çš„è®¾å¤‡æ ‘æ–‡ä»¶..."
        DTS_PATH="target/linux/ath79/dts/qca9563_csac.dts"
        if [ -f "$DTS_PATH" ]; then
          echo "âœ… æ‰¾åˆ°ath79è®¾å¤‡æ ‘: $DTS_PATH"
          echo "dts_valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ æœªæ‰¾åˆ°$DTS_PATHï¼Œath79è®¾å¤‡æ ‘ç›®å½•ä¸å­˜åœ¨"
          ls -la target/linux/ath79/dts/ || exit 1
          exit 1
        fi

    - name: è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev python3 python3-distutils python3-setuptools python3-pip \
          python3-pyelftools unzip wget rsync time xsltproc zlib1g-dev \
          subversion gperf bison flex asciidoc bash bc binutils bzip2 \
          diffutils findutils libc6-dev libtool make patch perl ruby sed \
          tar xmlto xxd cmake pkg-config curl jq  # æ–°å¢curl+jqç”¨äºWeTransferä¸Šä¼ 

    - name: å½»åº•æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼ˆç§»é™¤æ— å…³æ¶æ„ï¼‰
      run: |
        echo "ğŸ—‘ï¸  æ¸…ç†ç¼“å­˜ï¼Œç§»é™¤mediatekç­‰é”™è¯¯æ¶æ„æ®‹ç•™..."
        make clean && make dirclean
        rm -rf build_dir/target-mediatek_* bin/targets/mediatek/
        rm -rf build_dir/target-* tmp/
        echo "âœ… ç¼“å­˜æ¸…ç†å®Œæˆ"

    - name: é…ç½®ç¼–è¯‘å‚æ•°ï¼ˆå¼ºåˆ¶ath79/genericï¼‰
      run: |
        rootfs_size="${{ env.IMAGE_SIZE }}"
        rootfs_size="${rootfs_size%k}"
        # å¼ºåˆ¶ç”Ÿæˆath79æ¶æ„é…ç½®ï¼Œé¿å…è·³è½¬åˆ°å…¶ä»–æ¶æ„
        echo "CONFIG_TARGET_${{ env.TARGET }}=y" > .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE }}=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${rootfs_size}" >> .config
        echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        # è¿½åŠ è‡ªå®šä¹‰é…ç½®
        if [ -f "seed.config" ]; then
          cat seed.config >> .config
        fi
        if [ -n "${{ github.event.inputs.build_options }}" ]; then
          echo "${{ github.event.inputs.build_options }}" >> .config
        fi

    - name: ä¸‹è½½feedså¹¶å®‰è£…
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ç”Ÿæˆæœ€ç»ˆç¼–è¯‘é…ç½®
      run: |
        make defconfig
        echo "âœ… ç¼–è¯‘é…ç½®ç”Ÿæˆå®Œæˆï¼ˆæ¶æ„ï¼š${{ env.TARGET }}/${{ env.SUBTARGET }}ï¼‰"

    - name: æå‰ä¸‹è½½ä¾èµ–åŒ…
      run: |
        FORCE_UNSAFE_CONFIGURE=1 make download -j$(nproc)
        find dl -size -1024c -delete
        echo "âœ… æ‰€æœ‰ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘å›ºä»¶ï¼ˆç»‘å®šath79æ¶æ„ï¼‰
      run: |
        echo "å¼€å§‹ç¼–è¯‘ ${{ env.DEVICE }}ï¼ˆæ¶æ„ï¼š${{ env.TARGET }}/${{ env.SUBTARGET }}ï¼‰..."
        if ! time make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log; then
          echo "âš ï¸  å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œåˆ‡æ¢å•çº¿ç¨‹é‡æ–°ç¼–è¯‘..."
          time make -j1 V=s 2>&1 | tee -a build.log
          exit 1
        fi

    - name: æ£€æŸ¥å›ºä»¶ï¼ˆå¼ºåˆ¶å®šä½ath79ç›®å½•ï¼‰
      id: check_firmware
      run: |
        BIN_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        if [ ! -d "$BIN_DIR" ]; then
          echo "âŒ $BIN_DIR ç›®å½•ä¸å­˜åœ¨ï¼Œç¼–è¯‘å¤±è´¥"
          tail -200 build.log
          exit 1
        fi
        # æŸ¥æ‰¾CSACè®¾å¤‡ä¸“å±å›ºä»¶ï¼ˆè¿‡æ»¤å…¶ä»–è®¾å¤‡æ–‡ä»¶ï¼‰
        FIRMWARE_FILES=$(find "$BIN_DIR" -name "*${{ env.DEVICE }}*.bin" -o -name "*${{ env.DEVICE }}*.img")
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "âŒ $BIN_DIR ä¸­æœªæ‰¾åˆ°${{ env.DEVICE }}çš„å›ºä»¶æ–‡ä»¶"
          ls -la "$BIN_DIR"
          exit 1
        fi
        echo "âœ… å›ºä»¶ç”ŸæˆæˆåŠŸï¼æ–‡ä»¶åˆ—è¡¨ï¼š"
        echo "$FIRMWARE_FILES"
        # å‹ç¼©å›ºä»¶å’Œæ—¥å¿—ï¼Œæ–¹ä¾¿ä¸Šä¼ 
        mkdir -p upload_files
        cp $FIRMWARE_FILES upload_files/
        cp build.log .config upload_files/
        echo "UPLOAD_DIR=$(pwd)/upload_files" >> $GITHUB_ENV
        echo "âœ… å¾…ä¸Šä¼ æ–‡ä»¶å·²æ•´ç†åˆ° upload_files ç›®å½•"

    - name: ä¸Šä¼ åˆ°WeTransferå…è´¹ç‰ˆï¼ˆ7å¤©æœ‰æ•ˆæœŸï¼‰
      id: wetransfer_upload
      if: steps.check_firmware.outcome == 'success'
      run: |
        echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ åˆ°WeTransferï¼ˆå…è´¹7å¤©æœ‰æ•ˆæœŸï¼‰..."
        UPLOAD_DIR="${{ env.UPLOAD_DIR }}"
        # å‹ç¼©å¾…ä¸Šä¼ æ–‡ä»¶ï¼ˆå‡å°‘ä¸Šä¼ ä½“ç§¯ï¼‰
        ZIP_FILE="CSAC-OpenWrt-å›ºä»¶+æ—¥å¿—-$(date +%Y%m%d).zip"
        zip -r "$ZIP_FILE" "$UPLOAD_DIR"
        # è°ƒç”¨WeTransferå…è´¹ä¸Šä¼ æ¥å£ï¼ˆæ— éœ€APIå¯†é’¥ï¼‰
        RESPONSE=$(curl -s -X POST "https://wetransfer.com/api/v4/transfers" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "CSAC-OpenWrtå›ºä»¶åŠç¼–è¯‘æ—¥å¿—",
            "description": "CSAC-QCA9563è®¾å¤‡OpenWrtå›ºä»¶ï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰",
            "expires_at": "'$(date -d "+${{ env.WETRANSFER_EXPIRY }}" -Iseconds | sed 's/+00:00/Z/')'",
            "files": []
          }')
        # æå–transfer_idå’Œupload_url
        TRANSFER_ID=$(echo "$RESPONSE" | jq -r '.id')
        UPLOAD_URL=$(echo "$RESPONSE" | jq -r '.upload_url')
        if [ "$TRANSFER_ID" == "null" ] || [ "$UPLOAD_URL" == "null" ]; then
          echo "âŒ WeTransferä¸Šä¼ åˆå§‹åŒ–å¤±è´¥"
          echo "å“åº”å†…å®¹: $RESPONSE"
          exit 1
        fi
        # ä¸Šä¼ å‹ç¼©æ–‡ä»¶
        UPLOAD_RESPONSE=$(curl -s -X PUT "$UPLOAD_URL" \
          -H "Content-Type: application/zip" \
          --data-binary @"$ZIP_FILE")
        # æå–ä¸‹è½½é“¾æ¥
        DOWNLOAD_LINK="https://wetransfer.com/$TRANSFER_ID"
        echo "âœ… WeTransferä¸Šä¼ æˆåŠŸï¼"
        echo "ä¸‹è½½é“¾æ¥ï¼ˆ7å¤©æœ‰æ•ˆï¼‰: $DOWNLOAD_LINK"
        echo "DOWNLOAD_LINK=$DOWNLOAD_LINK" >> $GITHUB_ENV

    - name: å¤‡ä»½ä¸Šä¼ åˆ°GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CSAC-OpenWrtå›ºä»¶-${{ github.sha }}
        path: ${{ env.UPLOAD_DIR }}
        retention-days: 7

    - name: è¾“å‡ºæœ€ç»ˆç»“æœ
      if: always()
      run: |
        if [ -n "${{ env.DOWNLOAD_LINK }}" ]; then
          echo "ğŸ‰ ç¼–è¯‘+ä¸Šä¼ å…¨éƒ¨æˆåŠŸï¼"
          echo "WeTransferä¸‹è½½é“¾æ¥ï¼ˆ7å¤©æœ‰æ•ˆï¼‰: ${{ env.DOWNLOAD_LINK }}"
          echo "GitHub Artifactså¤‡ä»½: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        else
          echo "âŒ ç¼–è¯‘æˆ–ä¸Šä¼ å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          exit 1
        fi