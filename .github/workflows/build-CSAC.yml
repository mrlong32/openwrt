name: Build OpenWrt 25.12 (CSAC专用)

on:
  workflow_dispatch:
    inputs:
      build_options:
        description: '额外编译选项 (可选)'
        required: false
        default: ''
  push:
    branches: ["main", "master"]
  schedule:
    - cron: '0 2 * * 1'

env:
  TARGET: ath79
  SUBTARGET: generic
  DEVICE: csac_qca9563-csac
  BRANCH: main
  IMAGE_SIZE: 7808k

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    strategy:
      matrix:
        image_type: [squashfs]

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.BRANCH }}

    - name: 验证设备树文件
      id: verify_dts
      run: |
        DTS_PATH="target/linux/ath79/dts/qca9563_csac.dts"
        if [ -f "$DTS_PATH" ]; then
          echo "✅ 找到设备树文件: $DTS_PATH"
          echo "dts_valid=true" >> $GITHUB_OUTPUT
        else
          echo "❌ 未找到设备树文件 $DTS_PATH"
          exit 1
        fi

    - name: 设置编译环境
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk gettext git \
          java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev python3 python3-distutils python3-setuptools python3-pip \
          python3-pyelftools unzip wget rsync time xsltproc zlib1g-dev \
          subversion gperf bison flex asciidoc bash bc binutils bzip2 \
          diffutils findutils libc6-dev libtool make patch perl ruby sed \
          tar xmlto xxd cmake pkg-config zip unzip jq

    - name: 配置编译参数
      run: |
        ROOTFS_SIZE="${{ env.IMAGE_SIZE }}"
        ROOTFS_SIZE="${ROOTFS_SIZE%k}"
        if [ -f "seed.config" ]; then
          cp seed.config .config
        else
          echo "CONFIG_TARGET_${{ env.TARGET }}=y" > .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
          echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE }}=y" >> .config
        fi
        echo "CONFIG_DEVICE_DTS_OVERRIDE=1" >> .config
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${ROOTFS_SIZE}" >> .config
        if [ -n "${{ github.event.inputs.build_options }}" ]; then
          echo "${{ github.event.inputs.build_options }}" >> .config
        fi

    - name: 下载feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成编译配置
      run: |
        make defconfig
        echo "编译配置生成完成"

    - name: 开始编译
      run: |
        echo "开始编译 ${{ env.DEVICE }}..."
        if ! time make -j$(($(nproc)+1)) V=s 2>&1 | tee build.log; then
          echo "⚠️  多线程编译失败，切换单线程..."
          time make -j1 V=s 2>&1 | tee -a build.log
          exit 1
        fi

    - name: 检查编译结果
      id: check_firm
      run: |
        BIN_DIR="bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        if [ ! -d "$BIN_DIR" ] || [ -z "$(find $BIN_DIR -name "*.bin")" ]; then
          BIN_DIR=$(find build_dir/target-mips_24kc_musl/linux-ath79_generic/tmp -name "*.bin" | xargs -n1 dirname | head -1)
          if [ -z "$BIN_DIR" ]; then
            echo "❌ 未找到固件"
            tail -200 build.log
            exit 1
          fi
        fi
        echo "FIRMWARE_DIR=$BIN_DIR" >> $GITHUB_ENV

    - name: 压缩固件和日志
      if: steps.check_firm.outcome == 'success'
      run: |
        mkdir -p upload
        cp -r ${{ env.FIRMWARE_DIR }}/* upload/
        cp build.log .config upload/
        zip -r csac-openwrt.zip upload/

    - name: 上传到WeTransfer（7天有效）
      if: steps.check_firm.outcome == 'success'
      run: |
        # 初始化上传
        RESPONSE=$(curl -s -X POST "https://wetransfer.com/api/v4/transfers" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "CSAC-OpenWrt固件",
            "description": "CSAC设备OpenWrt固件",
            "expires_at": "'$(date -d "+7 days" -Iseconds | sed 's/+00:00/Z/')'",
            "files": []
          }')
        TRANSFER_ID=$(echo "$RESPONSE" | jq -r '.id')
        UPLOAD_URL=$(echo "$RESPONSE" | jq -r '.upload_url')
        # 上传压缩包
        curl -s -X PUT "$UPLOAD_URL" \
          -H "Content-Type: application/zip" \
          --data-binary @"csac-openwrt.zip"
        # 输出下载链接
        echo "✅ WeTransfer下载链接（7天有效）: https://wetransfer.com/$TRANSFER_ID"

    - name: 上传日志到Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        retention-days: 7