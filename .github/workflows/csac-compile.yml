name: OpenWrt CSAC Compile
true:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main
  schedule:
  - cron: 0 0 * * 0
  workflow_dispatch: null
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - name: Update feeds
      run: "\n# \u786E\u4FDD\u914D\u7F6ECSAC\u8BBE\u5907\necho 'CONFIG_TARGET_ath79=y'\
        \ >> .config\necho 'CONFIG_TARGET_ath79_generic=y' >> .config\necho 'CONFIG_TARGET_ath79_generic_DEVICE_xwrt_csac=y'\
        \ >> .config\necho 'CONFIG_PACKAGE_ath10k-firmware-qca9886-ct=y' >> .config\n\
        echo 'CONFIG_PACKAGE_kmod-switch-qca8k=y' >> .config\n./scripts/feeds update\
        \ -a\n./scripts/feeds install -a\n"
    - name: Load CSAC configuration
      run: "echo 'CONFIG_TARGET_ath79=y' >> .config\necho 'CONFIG_TARGET_ath79_generic=y'\
        \ >> .config\necho 'CONFIG_TARGET_ath79_generic_DEVICE_xwrt_csac=y' >> .config\n\
        # \u65E0\u7EBF\u9A71\u52A8\u914D\u7F6E\necho 'CONFIG_PACKAGE_kmod-ath10k-ct=y'\
        \ >> .config\necho 'CONFIG_PACKAGE_ath10k-firmware-qca9886-ct=y' >> .config\n\
        # \u4EA4\u6362\u82AF\u7247\u914D\u7F6E\necho 'CONFIG_PACKAGE_kmod-switch-qca8k=y'\
        \ >> .config\necho 'CONFIG_PACKAGE_swconfig=y' >> .config\n# USB\u652F\u6301\
        \necho 'CONFIG_PACKAGE_kmod-usb-core=y' >> .config\necho 'CONFIG_PACKAGE_kmod-usb2=y'\
        \ >> .config\n# Luci\u754C\u9762\necho 'CONFIG_PACKAGE_luci=y' >> .config\n\
        echo 'CONFIG_PACKAGE_luci-theme-openwrt-2020=y' >> .config\necho 'CONFIG_PACKAGE_luci-app-opkg=y'\
        \ >> .config\n# \u5176\u4ED6\u5DE5\u5177\necho 'CONFIG_PACKAGE_firewall=y'\
        \ >> .config\necho 'CONFIG_PACKAGE_wireless-tools=y' >> .config\necho 'CONFIG_PACKAGE_iw=y'\
        \ >> .config\n# \u7F16\u8BD1\u4F18\u5316\necho 'CONFIG_DEVEL=y' >> .config\n\
        echo 'CONFIG_BUILD_OPTIMIZE=y' >> .config\necho 'CONFIG_BUILD_DEBUG=n' >>\
        \ .config\n"
    - name: Update configuration
      run: "\n# \u786E\u4FDD\u914D\u7F6ECSAC\u8BBE\u5907\necho 'CONFIG_TARGET_ath79=y'\
        \ >> .config\necho 'CONFIG_TARGET_ath79_generic=y' >> .config\necho 'CONFIG_TARGET_ath79_generic_DEVICE_xwrt_csac=y'\
        \ >> .config\necho 'CONFIG_PACKAGE_ath10k-firmware-qca9886-ct=y' >> .config\n\
        echo 'CONFIG_PACKAGE_kmod-switch-qca8k=y' >> .config\nmake defconfig\n"
    - name: Download dependencies
      run: "\n# \u786E\u4FDD\u914D\u7F6ECSAC\u8BBE\u5907\necho 'CONFIG_TARGET_ath79=y'\
        \ >> .config\necho 'CONFIG_TARGET_ath79_generic=y' >> .config\necho 'CONFIG_TARGET_ath79_generic_DEVICE_xwrt_csac=y'\
        \ >> .config\necho 'CONFIG_PACKAGE_ath10k-firmware-qca9886-ct=y' >> .config\n\
        echo 'CONFIG_PACKAGE_kmod-switch-qca8k=y' >> .config\nmake download -j$(nproc)\n"
    - name: Build firmware
      run: "\n# \u786E\u4FDD\u914D\u7F6ECSAC\u8BBE\u5907\necho 'CONFIG_TARGET_ath79=y'\
        \ >> .config\necho 'CONFIG_TARGET_ath79_generic=y' >> .config\necho 'CONFIG_TARGET_ath79_generic_DEVICE_xwrt_csac=y'\
        \ >> .config\necho 'CONFIG_PACKAGE_ath10k-firmware-qca9886-ct=y' >> .config\n\
        echo 'CONFIG_PACKAGE_kmod-switch-qca8k=y' >> .config\nmake -j$(nproc) || make\
        \ -j1 V=s\n"
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-csac-firmware
        path: bin/targets/ath79/generic/*.bin
    timeout-minutes: 120
    